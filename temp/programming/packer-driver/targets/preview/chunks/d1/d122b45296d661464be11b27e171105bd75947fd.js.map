{"version":3,"sources":["file:///D:/Desktop/cocosProject/SlotBar/assets/slotBar/scripts/unit/TipTextController.ts"],"names":["_decorator","Component","instantiate","Node","NodePool","Prefab","RichText","tween","UIOpacity","Vec3","EventBus","tipTextEventTypes","ccclass","property","T","tipPool","currentTipNode","fadeTween","tipTextListener","payload","onShowTip","text","duration","onEnable","tipTextEventBus","on","ShowTipText","onDisable","off","message","stop","uiOpacity","getComponent","removeFromParent","put","undefined","tipNode","size","get","console","log","tipTextPrefab","tipParent","addChild","richText","string","addComponent","setPosition","opacity","to","position","start","delay","call"],"mappings":"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","sourcesContent":["import {_decorator, Component, instantiate, Node, NodePool, Prefab, RichText, Tween, tween, UIOpacity, Vec3} from 'cc';\r\nimport EventBus from \"db://assets/slotBar/scripts/eventSystem/EventCenter\";\r\nimport {tipTextEventTypes} from \"db://assets/slotBar/scripts/eventSystem/EventTypes\";\r\n\r\nconst {ccclass, property} = _decorator;\r\n\r\n@ccclass('TipTextController')\r\nexport class T extends Component {\r\n    @property(Prefab)\r\n    tipTextPrefab: Prefab = null!;\r\n\r\n    @property(Node)\r\n    tipParent: Node = null!;\r\n\r\n    private tipPool = new NodePool();\r\n\r\n    private currentTipNode: Node | null = null;\r\n    private fadeTween?: Tween<UIOpacity>; // 增加這個屬性\r\n    private tipTextListener = (payload: { text: string, duration?: number }) => {\r\n        this.onShowTip(payload.text, payload.duration);\r\n    };\r\n\r\n    onEnable() {\r\n        EventBus.tipTextEventBus.on(tipTextEventTypes.ShowTipText, this.tipTextListener, this);\r\n    }\r\n\r\n    onDisable() {\r\n        EventBus.tipTextEventBus.off(tipTextEventTypes.ShowTipText, this.tipTextListener, this);\r\n    }\r\n\r\n\r\n    private onShowTip(message: string, duration: number = 2) {\r\n        // 停止並回收現有提示\r\n        if (this.currentTipNode) {\r\n            tween(this.currentTipNode).stop();\r\n\r\n            const uiOpacity = this.currentTipNode.getComponent(UIOpacity);\r\n            if (uiOpacity && this.fadeTween) {\r\n                this.fadeTween.stop();\r\n            }\r\n\r\n            this.currentTipNode.removeFromParent();\r\n            this.tipPool.put(this.currentTipNode);\r\n            this.currentTipNode = null;\r\n            this.fadeTween = undefined;\r\n        }\r\n\r\n        // 取得或實例化節點\r\n        let tipNode: Node;\r\n        if (this.tipPool.size() > 0) {\r\n            tipNode = this.tipPool.get()!;\r\n        } else {\r\n            console.log(\"生成新的tipTextPrefab\");\r\n            tipNode = instantiate(this.tipTextPrefab);\r\n        }\r\n\r\n        this.tipParent.addChild(tipNode);\r\n\r\n        const richText = tipNode.getComponent(RichText);\r\n        if (richText) richText.string = message;\r\n\r\n        this.currentTipNode = tipNode;\r\n\r\n        // 確保有 UIOpacity\r\n        let uiOpacity = tipNode.getComponent(UIOpacity);\r\n        if (!uiOpacity) {\r\n            uiOpacity = tipNode.addComponent(UIOpacity);\r\n        }\r\n\r\n        tipNode.setPosition(0, 220, 0);\r\n        uiOpacity.opacity = 0;\r\n\r\n        tween(tipNode)\r\n            .to(0.3, { position: new Vec3(0, 250, 0) })\r\n            .start();\r\n\r\n        this.fadeTween = tween(uiOpacity)\r\n            .to(0.3, { opacity: 255 })\r\n            .delay(duration)\r\n            .to(0.3, { opacity: 0 })\r\n            .call(() => {\r\n                tipNode.removeFromParent();\r\n                this.tipPool.put(tipNode);\r\n                if (this.currentTipNode === tipNode) {\r\n                    this.currentTipNode = null;\r\n                }\r\n                this.fadeTween = undefined;\r\n            })\r\n            .start();\r\n    }\r\n\r\n}\r\n\r\n\r\n"]}