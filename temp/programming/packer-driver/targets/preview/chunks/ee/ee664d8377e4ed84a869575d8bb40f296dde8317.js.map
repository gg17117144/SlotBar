{"version":3,"sources":["file:///D:/Desktop/cocosProject/SlotBar/assets/slotBar/scripts/controllers/SlotController.ts"],"names":["_decorator","assetManager","Component","SpriteFrame","Texture2D","EventBus","soltEventTypes","MockData","WebSocketService","ccclass","property","SlotController","symbolDataList","spinCompletedCount","onEnable","slotBarEventBus","on","SpinStart","onSpinStart","AllReelsFinished","onAllReelsFinished","onDisable","off","start","data","getMockSymbolData","preloadAllSymbols","connectWebSocket","emit","InitReel","error","console","msg","log","event","FetchResult","spinStart","symbols","loadedCount","Promise","resolve","reject","forEach","symbol","loadRemote","imageUrl","err","imageAsset","texture","image","spriteFrame","length"],"mappings":"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","sourcesContent":["import {_decorator, assetManager, Component, ImageAsset, SpriteFrame, Texture2D} from 'cc';\r\nimport EventBus from '../eventSystem/EventCenter';\r\nimport {soltEventTypes} from '../eventSystem/EventTypes';\r\nimport {MockData} from '../mockData/MockData';\r\nimport {SymbolData} from '../types/SymbolData';\r\nimport {WebSocketService} from \"db://assets/slotBar/scripts/services/WebSocketService\";\r\n\r\nconst {ccclass, property} = _decorator;\r\n\r\n@ccclass('SlotController')\r\nexport class SlotController extends Component {\r\n    private symbolDataList: SymbolData[] = [];\r\n\r\n    private spinCompletedCount = 0; // ç”¨ä¾†è¨˜éŒ„å®Œæˆå¹¾å€‹æ»¾è¼ª\r\n\r\n    onEnable() {\r\n        EventBus.slotBarEventBus.on(soltEventTypes.SpinStart, this.onSpinStart, this); // è¨»å†Šäº‹ä»¶-é–‹å§‹æ—‹è½‰\r\n        EventBus.slotBarEventBus.on(soltEventTypes.AllReelsFinished, this.onAllReelsFinished, this); // è¨»å†Šäº‹ä»¶-æ‰€æœ‰æ»¾è¼ªå®Œæˆ\r\n    }\r\n\r\n    onDisable() {\r\n        EventBus.slotBarEventBus.off(soltEventTypes.SpinStart, this.onSpinStart, this); // å–æ¶ˆè¨»å†Šäº‹ä»¶-é–‹å§‹æ—‹è½‰\r\n        EventBus.slotBarEventBus.off(soltEventTypes.AllReelsFinished, this.onAllReelsFinished, this); // å–æ¶ˆè¨»å†Šäº‹ä»¶-æ‰€æœ‰æ»¾è¼ªå®Œæˆ\r\n    }\r\n\r\n    async start() {\r\n        try {\r\n            let data: SymbolData[];\r\n            // ä½¿ç”¨mockè³‡æ–™\r\n            data = MockData.getMockSymbolData();\r\n            // å‘ä¼ºæœå™¨æ‰“apiæ‹¿SymbolData\r\n            // data = await ApiService.fetchSymbolData();\r\n\r\n            this.symbolDataList = data;\r\n            await this.preloadAllSymbols(this.symbolDataList);\r\n\r\n            await this.connectWebSocket();\r\n\r\n            EventBus.slotBarEventBus.emit(soltEventTypes.InitReel, data); // ç™¼é€äº‹ä»¶ï¼Œé€šçŸ¥SymbolDataå·²ç¶“è¼‰å…¥å®Œæˆ\r\n        } catch (error) {\r\n            console.error('è®€å–è¼‰å…¥åœ–ç‰‡å¤±æ•—æˆ–tokenæœ‰å•é¡Œ:', error);\r\n        }\r\n    }\r\n\r\n    private async connectWebSocket() {\r\n        WebSocketService.connectWebSocket(async (msg: any) => {\r\n            console.log(\"ğŸ“© æ”¶åˆ°å¾Œç«¯è¨Šæ¯ï¼š\", msg);\r\n\r\n            // å‡è¨­æ”¶åˆ°çš„æ˜¯ spin çµæœ\r\n            if (msg.event === \"SpinResult\") {\r\n                // å‘¼å«å°æ‡‰æ–¹æ³•è™•ç†\r\n                // const results: string[] = (msg.data.result as any[]).map(item => String(item));\r\n                EventBus.slotBarEventBus.emit(soltEventTypes.FetchResult, msg.data);\r\n                // EventBus.slotBarEventBus.emit(soltEventTypes.UpdateCoinText, msg.data.balance);\r\n            }\r\n        });\r\n    }\r\n\r\n    private async onSpinStart() {\r\n        WebSocketService.spinStart(10);\r\n    }\r\n\r\n    private async onAllReelsFinished() {\r\n        // å°‡è³‡æ–™å­˜é€²å¾Œç«¯\r\n    }\r\n\r\n    // é è¼‰å…¥æ‰€æœ‰ç¬¦è™Ÿåœ–ç‰‡ (é€™è£¡é‚„å¯ä»¥æ‹†å‡ºå»modleåšæ“ä½œ)\r\n    preloadAllSymbols(symbols: SymbolData[]): Promise<void> {\r\n        let loadedCount = 0;\r\n        return new Promise((resolve, reject) => {\r\n            symbols.forEach((symbol) => {\r\n                assetManager.loadRemote(symbol.imageUrl, (err, imageAsset: ImageAsset) => {\r\n                    if (err) {\r\n                        reject(err);\r\n                        return;\r\n                    }\r\n\r\n                    const texture = new Texture2D();\r\n                    texture.image = imageAsset;\r\n\r\n                    const spriteFrame = new SpriteFrame();\r\n                    spriteFrame.texture = texture;\r\n\r\n                    symbol.spriteFrame = spriteFrame;\r\n\r\n                    loadedCount++;\r\n                    if (loadedCount === symbols.length) {\r\n                        resolve();\r\n                    }\r\n                });\r\n            });\r\n        });\r\n    }\r\n}"]}